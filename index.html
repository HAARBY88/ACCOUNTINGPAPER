<h2>Companies House Search</h2>
<div id="companies-house-tab">
  <input type="text" id="companySearch" placeholder="Enter company name">
  <button onclick="searchCompany()">Search</button>

  <div id="companyResults"></div>
  <div id="filingResults"></div>

  <h3>Filters</h3>
  Start Date: <input type="date" id="filterStart"><br>
  End Date: <input type="date" id="filterEnd"><br>
  Document Types:
  <select id="filterTypes" multiple>
    <option value="AA">Annual Accounts</option>
    <option value="CS">Confirmation Statement</option>
    <option value="AR">Annual Return</option>
  </select><br>
  <button onclick="analyseSelected()">Analyse Selected</button>
</div>

<script>
let selectedFilings = [];

async function searchCompany() {
  const q = document.getElementById("companySearch").value;
  const res = await fetch(`/.netlify/functions/searchCompany?q=${encodeURIComponent(q)}`);
  const data = await res.json();

  const resultsDiv = document.getElementById("companyResults");
  resultsDiv.innerHTML = "";
  data.items.forEach(company => {
    resultsDiv.innerHTML += `
      <div>
        <strong>${company.title}</strong> (${company.company_number})
        <button onclick="loadFilings('${company.company_number}')">View Filings</button>
      </div>`;
  });
}

async function loadFilings(companyNumber) {
  const res = await fetch(`/.netlify/functions/filingHistory/${companyNumber}`);
  const data = await res.json();
  const filingsDiv = document.getElementById("filingResults");
  filingsDiv.innerHTML = "";

  data.items.forEach(filing => {
    filingsDiv.innerHTML += `
      <div>
        <input type="checkbox" onchange="toggleFiling('${filing.transaction_id}', '${filing.type}', '${filing.date}')">
        ${filing.description || "No description"} (${filing.date})
      </div>`;
  });
}

function toggleFiling(documentId, type, date) {
  const index = selectedFilings.findIndex(f => f.documentId === documentId);
  if (index >= 0) {
    selectedFilings.splice(index, 1);
  } else {
    selectedFilings.push({ documentId, type, date });
  }
}

async function analyseSelected() {
  const filters = {
    startDate: document.getElementById("filterStart").value,
    endDate: document.getElementById("filterEnd").value,
    types: Array.from(document.getElementById("filterTypes").selectedOptions).map(o => o.value)
  };

  const res = await fetch(`/.netlify/functions/analyseFilings`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ filings: selectedFilings, filters })
  });

  const data = await res.json();
  console.log("AI Draft Output:", data.result);
}
</script>
