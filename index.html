ifrs-usgaap-memo/
├─ netlify.toml
├─ package.json
├─ public/
│  └─ index.html
├─ netlify/
│  └─ functions/
│     ├─ draft-memo.ts
│     └─ ingest-chunks.ts
└─ sql/
   └─ schema.sql

[build]
  publish = "public"
  functions = "netlify/functions"

[functions]
  node_bundler = "esbuild"
  external_node_modules = ["openai", "pg"]

# Optional: add headers to disable caching for dynamic responses
[[headers]]
  for = "/*"
  [headers.values]
    Cache-Control = "no-store"

{
  "name": "ifrs-usgaap-memo",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "netlify dev",
    "build": "echo \"static site\"",
    "format": "prettier -w ."
  },
  "dependencies": {
    "openai": "^4.56.0",
    "pg": "^8.11.5"
  },
  "devDependencies": {
    "esbuild": "^0.23.0",
    "prettier": "^3.3.3"
  }
}

-- Enable pgvector (in Supabase it's preinstalled; otherwise: CREATE EXTENSION IF NOT EXISTS vector; )
CREATE EXTENSION IF NOT EXISTS vector;

-- All uploaded/curated documents (filings, prior memos, standards summaries)
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company TEXT,                    -- null for general standards summaries
  title TEXT NOT NULL,
  type TEXT NOT NULL,              -- 'fs','memo','policy','standard-summary'
  framework TEXT,                  -- 'IFRS','US GAAP', or null for company docs
  period_start DATE,
  period_end DATE,
  source_url TEXT,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Chunked text with embeddings
CREATE TABLE chunks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  document_id UUID REFERENCES documents(id) ON DELETE CASCADE,
  section TEXT,
  page INT,
  text TEXT NOT NULL,
  metadata JSONB,
  embedding VECTOR(1536)           -- for text-embedding-3-* 1536 dims
);

-- Memos generated (store draft + citations + provenance)
CREATE TABLE memos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  company TEXT,
  title TEXT,
  framework TEXT,                  -- 'IFRS' | 'US GAAP'
  reporting_period_start DATE,
  reporting_period_end DATE,
  status TEXT DEFAULT 'draft',     -- 'draft','review','final'
  draft_text TEXT,
  citations JSONB,                 -- [{ref:1, document_id, page, section}]
  context_ids UUID[],              -- chunk ids used
  created_by TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFRS + US GAAP Memo Drafting</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <main class="max-w-3xl mx-auto p-6 space-y-6">
    <header>
      <h1 class="text-3xl font-bold">Auditor-Ready Memo Drafts</h1>
      <p class="text-gray-600">Uses prior filings/memos + standards (IFRS/US GAAP) with retrieval-augmented generation.</p>
    </header>

    <section class="bg-white p-4 rounded-xl shadow">
      <h2 class="font-semibold text-lg mb-3">Draft Wizard</h2>
      <form id="memoForm" class="space-y-4">
        <div>
          <label class="block font-medium mb-1">Framework</label>
          <select name="framework" class="w-full border rounded-lg p-2">
            <option>IFRS</option>
            <option>US GAAP</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Company</label>
            <input name="company" class="w-full border rounded-lg p-2" placeholder="Example: Horizon PLC" />
          </div>
          <div>
            <label class="block font-medium mb-1">Reporting period (YYYY-MM)</label>
            <input name="period" class="w-full border rounded-lg p-2" placeholder="2025-06" />
          </div>
        </div>

        <div>
          <label class="block font-medium mb-1">Transaction / Issue (facts)</label>
          <textarea name="facts" rows="5" class="w-full border rounded-lg p-2"
            placeholder="Summarize the transaction: nature, dates, amounts, performance obligations, judgements, contracts involved."></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block font-medium mb-1">Desired focus</label>
            <select name="focus" class="w-full border rounded-lg p-2">
              <option>Recognition & measurement</option>
              <option>Presentation</option>
              <option>Disclosure</option>
              <option>All of the above</option>
            </select>
          </div>
          <div>
            <label class="block font-medium mb-1">Output length</label>
            <select name="length" class="w-full border rounded-lg p-2">
              <option>Concise (1–2 pages)</option>
              <option>Standard (3–5 pages)</option>
              <option>Extended (6–8 pages)</option>
            </select>
          </div>
        </div>

        <div class="p-3 bg-gray-50 border rounded-lg">
          <p class="text-sm text-gray-700 mb-1 font-medium">Live Prompt Preview</p>
          <pre id="preview" class="text-xs text-gray-700 whitespace-pre-wrap"></pre>
        </div>

        <button class="px-4 py-2 bg-blue-600 text-white rounded-lg">Generate Draft</button>
      </form>
    </section>

    <section id="resultSection" class="hidden bg-white p-4 rounded-xl shadow">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold text-lg">Draft Memo</h2>
        <button id="copyBtn" class="text-sm px-3 py-1 border rounded-lg">Copy</button>
      </div>
      <article id="draft" class="prose max-w-none whitespace-pre-wrap"></article>
    </section>

    <footer class="text-xs text-gray-500">
      Output is a draft. Verify against authoritative literature and your firm’s policies before use.
    </footer>
  </main>

  <script>
    const form = document.getElementById('memoForm');
    const preview = document.getElementById('preview');
    const resultSection = document.getElementById('resultSection');
    const draftEl = document.getElementById('draft');
    const copyBtn = document.getElementById('copyBtn');

    function makePreview(fd) {
      const framework = fd.get('framework');
      const facts = fd.get('facts') || '';
      const focus = fd.get('focus');
      const length = fd.get('length');
      const period = fd.get('period') || 'n/a';
      return `Role: Senior technical accountant.
Framework: ${framework}. Reporting period: ${period}.
Instruction: Write an auditor-ready paper with sections:
Background; Facts; Accounting Analysis; Judgements & Alternatives; Conclusion; References; Appendix (calculations).
Focus: ${focus}. Target length: ${length}.
Only use cited material from retrieved context; if insufficient, list missing evidence.
Facts:\n${facts}`;
    }

    form.addEventListener('input', () => {
      const fd = new FormData(form);
      preview.textContent = makePreview(fd);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const body = {
        framework: fd.get('framework'),
        company: fd.get('company'),
        period: fd.get('period'),
        facts: fd.get('facts'),
        focus: fd.get('focus'),
        length: fd.get('length')
      };
      draftEl.textContent = 'Generating…';
      resultSection.classList.remove('hidden');

      const res = await fetch('/.netlify/functions/draft-memo', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const data = await res.json();
      draftEl.textContent = data.memo || data.error || 'No draft returned.';
    });

    copyBtn.addEventListener('click', async () => {
      await navigator.clipboard.writeText(draftEl.textContent);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 1200);
    });
  </script>
</body>
</html>

import type { Handler } from '@netlify/functions';
import OpenAI from 'openai';
import pg from 'pg';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });

export const handler: Handler = async (event) => {
  try {
    const { facts, framework, company, period, focus, length, k = 10 } =
      JSON.parse(event.body || '{}');

    if (!facts || !framework) {
      return { statusCode: 400, body: JSON.stringify({ error: 'framework and facts are required' }) };
    }

    const queryStr = `${framework}\nCompany:${company || ''}\nPeriod:${period || ''}\nFocus:${focus || ''}\nFacts:${facts}`;
    const emb = await openai.embeddings.create({
      model: 'text-embedding-3-large',
      input: queryStr
    });
    const vec = emb.data[0].embedding;

    const client = await pool.connect();
    // Optional: scope retrieval to framework and/or company materials first
    const { rows } = await client.query(
      `
      SELECT id, text, metadata
      FROM chunks
      WHERE
        (
          (metadata->>'framework') IS NULL
          OR (metadata->>'framework') = $2 -- match IFRS/US GAAP summaries
          OR (metadata->>'company') = $3   -- company-specific materials
        )
      ORDER BY embedding <-> $1
      LIMIT $4
      `,
      [Buffer.from(new Float32Array(vec).buffer), framework, company || '', k]
    );
    client.release();

    const context = rows.map((r, i) =>
      `[[${i+1}]] ${r.text}\n(meta: ${JSON.stringify(r.metadata)})`
    ).join('\n\n');

    const sys = `You are a senior technical accountant.
- Produce auditor-ready memos with explicit citations like [1], [2] that map to the retrieved context items below.
- Structure: Background; Facts; Accounting Analysis; Judgements & Alternatives; Conclusion; References; Appendix (calculations).
- Be precise, neutral, and avoid speculation. If evidence is missing, state exactly what is missing.`;

    const user =
`Framework: ${framework}
Company: ${company || 'n/a'}
Reporting period: ${period || 'n/a'}
Desired focus: ${focus || 'All'}
Target length: ${length || 'Standard'}

Facts:
${facts}

Retrieved context (numbered):
${context}

Write the memo. Include a References section mapping [n] to (document title/metadata, section/page).`;

    const chat = await openai.chat.completions.create({
      model: 'gpt-5.1',   // adjust to your available model
      temperature: 0.2,
      messages: [
        { role: 'system', content: sys },
        { role: 'user', content: user }
      ]
    });

    return {
      statusCode: 200,
      body: JSON.stringify({ memo: chat.choices[0].message?.content || '' })
    };
  } catch (e: any) {
    return { statusCode: 500, body: JSON.stringify({ error: e.message || 'server error' }) };
  }
};

import type { Handler } from '@netlify/functions';
import OpenAI from 'openai';
import pg from 'pg';

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });

/**
 * Body shape:
 * {
 *   document: { title, type, framework?, company?, period_start?, period_end?, source_url? },
 *   chunks: [{ text, section?, page?, metadata? }, ...]
 * }
 */
export const handler: Handler = async (event) => {
  try {
    const payload = JSON.parse(event.body || '{}');
    const { document, chunks } = payload;

    if (!document?.title || !document?.type || !Array.isArray(chunks) || chunks.length === 0) {
      return { statusCode: 400, body: 'Invalid payload' };
    }

    const client = await pool.connect();
    try {
      await client.query('BEGIN');

      const docRes = await client.query(
        `INSERT INTO documents (company, title, type, framework, period_start, period_end, source_url)
         VALUES ($1,$2,$3,$4,$5,$6,$7)
         RETURNING id`,
        [
          document.company || null,
          document.title,
          document.type,
          document.framework || null,
          document.period_start || null,
          document.period_end || null,
          document.source_url || null
        ]
      );
      const documentId = docRes.rows[0].id;

      // embed in batches
      const texts = chunks.map((c: any) => c.text);
      const embs = await openai.embeddings.create({
        model: 'text-embedding-3-large',
        input: texts
      });

      for (let i = 0; i < chunks.length; i++) {
        const c = chunks[i];
        const e = embs.data[i].embedding;
        const md = {
          ...(c.metadata || {}),
          framework: document.framework || null,
          company: document.company || null,
          title: document.title || null
        };
        await client.query(
          `INSERT INTO chunks (document_id, section, page, text, metadata, embedding)
           VALUES ($1,$2,$3,$4,$5,$6)`,
          [
            documentId,
            c.section || null,
            c.page || null,
            c.text,
            md,
            Buffer.from(new Float32Array(e).buffer)
          ]
        );
      }

      await client.query('COMMIT');
      return { statusCode: 200, body: JSON.stringify({ documentId, chunks: chunks.length }) };
    } catch (err: any) {
      await client.query('ROLLBACK');
      throw err;
    } finally {
      client.release();
    }
  } catch (e: any) {
    return { statusCode: 500, body: e.message || 'error' };
  }
};

curl -X POST https://YOUR_SITE.netlify.app/.netlify/functions/ingest-chunks \
  -H "Content-Type: application/json" \
  -d '{
    "document": { "title":"IFRS 15 Summary v2025Q3", "type":"standard-summary", "framework":"IFRS" },
    "chunks": [
      { "section":"Scope", "page":1, "text":"IFRS 15 applies to contracts with customers ...", "metadata":{"effective_from":"2018-01-01"} },
      { "section":"Step 1", "page":2, "text":"Identify the contract with a customer ...", "metadata":{"effective_from":"2018-01-01"} }
    ]
  }'
